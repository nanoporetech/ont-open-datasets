{"componentChunkName":"component---src-templates-blog-post-js","path":"/gm24385_snp/","result":{"data":{"site":{"siteMetadata":{"title":"Oxford Nanopore Technologies Open Datasets"}},"markdownRemark":{"id":"f16b790a-6ec9-5456-a011-a6b39fb2c782","excerpt":"In this blog post we will explore small variant calling using the previously\nreleased HG002 (GM24385 Ashkenazi Son) data release. The GM24385 dataset comprises…","html":"<p>In this blog post we will explore small variant calling using the <a href=\"/ont-open-datasets/gm24385_2020.09\">previously\nreleased</a> HG002 (GM24385 Ashkenazi Son) data release.</p>\n<p>The GM24385 dataset comprises whole genome sequencing of a well-characterised\nhuman cell line. It therefore provides a useful benchmark sample; the cell line\nwas also used as a “seen” sample in the recent\n<a href=\"PrecisionFDA%20Truth%0AChallenge%20V2\">https://precision.fda.gov/challenges/10/view/results</a> competition.</p>\n<h3>Variant Calling with Medaka and DeepVariant</h3>\n<p>As an easily reproducible example we will focus on chromosome 20 of the genome\nrather than performing computation on the whole genome.</p>\n<blockquote>\n<p><em>This walkthrough assumes some familiarity with standard bioinformatic tools\nfor handling genomics data. A working installation of\n<a href=\"http://www.htslib.org/\">samtools</a>,\n<a href=\"https://bedtools.readthedocs.io/en/latest/\">bedtools</a>,\n<a href=\"https://github.com/nanoporetech/medaka\">medaka</a>,\n<a href=\"https://www.docker.com/get-started\">docker</a>, and the <a href=\"https://aws.amazon.com/cli/\">AWS command-line\ntools</a> are required to follow the process\nbelow.</em></p>\n</blockquote>\n<h4>Data preparation</h4>\n<p>To start let us download the pre-aligned reads corresponding to chromosome 20\nfrom the dataset resource (see our <a href=\"/ont-open-datasets/tutorials\">tutorial</a> FAQs) for more\ninformation on downloading data):</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">for ext in .bam .bam.bai; do\n    aws s3 --no-sign-request cp s3://ont-open-data/gm24385_2020.09/analysis/r9.4.1/20200914_1354_6B_PAF27096_e7c9eae6/guppy_v4.0.11_r9.4.1_hac_prom/align_unfiltered/chr20/calls2ref${ext} PAF27096.chr20${ext}\n    aws s3 --no-sign-request cp s3://ont-open-data/gm24385_2020.09/analysis/r9.4.1/20200914_1357_1-E11-H11_PAF27462_d3c9678e/guppy_v4.0.11_r9.4.1_hac_prom/align_unfiltered/chr20/calls2ref${ext} PAF27462.chr20${ext}\ndone</code></pre></div>\n<p>and merge these into a single <code class=\"language-text\">.bam</code> file:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">samtools merge chr20.bam PAF27096.chr20.bam PAF27462.chr20.bam\nsamtools index chr20.bam</code></pre></div>\n<p>As an additional step we will filter the <code class=\"language-text\">chr20.bam</code> file to leave only primary\nalignments, removing secondary and supplementary alignments. This is necessary\nas DeepVariant, which we will use later, will otherwise process these\nadditional alignments.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">samtools view chr20.bam -F 2308 -@ 64 -b &gt; chr20.primary.bam\nsamtools index chr20.primary.bam</code></pre></div>\n<p>To perform variant calling we also require the human reference sequence, the\nsame sequence as used to create the alignment files prepared above. An indexed\ncopy of this is available from the dataset resource:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">for ext in .fasta .fasta.fai; do\n    aws s3 --no-sign-request cp s3://ont-open-data/gm24385_2020.09/config/ref/GCA_000001405.15_GRCh38_no_alt_analysis_set${ext} .\ndone</code></pre></div>\n<p>We have now all the inputs required to perform variant calling with medaka\nand DeepVariant.</p>\n<h4>Running Medaka</h4>\n<p><a href=\"https://github.com/nanoporetech/medaka\">Medaka</a> is Oxford Nanopore\nTechnologies’ software for performing consensus and small variant calling from\nnanopore long-read data. It can perform diploid variant calling either in\nisolation or in tandem with\n<a href=\"https://github.com/google/deepvariant\">DeepVariant</a>; to enable this second\nuse-case small modifications have been made to how medaka represents variants\nto allow it to function as a variant-candidate generator for DeepVariant.</p>\n<p>To perform candidate generation with medaka we run:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">medaka_variant -i chr20.primary.bam -f GCA_000001405.15_GRCh38_no_alt_analysis_set.fasta \\\n    -r chr20 -t 8 -P 0 -l</code></pre></div>\n<p>The final two options here (<code class=\"language-text\">-P 0 -l</code>) instruct medaka to leave its\nsubstitution calls unfiltered and to decompose multi-nucleotide substitutions\ninto independent single nucleotide substitutions. Details of workflow employed\nby the <code class=\"language-text\">medaka_variant</code> program can be found in the medaka\n<a href=\"https://nanoporetech.github.io/medaka/snp.html#\">documentation</a>.</p>\n<p>The result of running the above command will be a directory <code class=\"language-text\">medaka_variant</code>\ncontaining (amongst other files):</p>\n<ul>\n<li><em><code class=\"language-text\">round_0_hap_mixed_phased.bam</code></em>: alignments (as in <code class=\"language-text\">chr20.primary.bam</code>), tagged with a calculated haplotype,</li>\n<li><em><code class=\"language-text\">round_1.vcf</code></em>: the final output variant candidates for DeepVariant.</li>\n</ul>\n<h4>Running DeepVariant</h4>\n<p>With variant-candidate generation performed by medaka we can now use\nDeepVariant to calculate our final variant calls. In order to simplify this we\nwill download a program that automates the execution of the docker container\nused to run DeepVariant:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">wget https://gist.githubusercontent.com/cjw85/23d2b0675ec5a5c7fd4074456524c971/raw/c716c85639f047b9a9cff2079be2868bccb61659/run_deepvariant.sh\nchmod +x run_deepvariant.sh</code></pre></div>\n<p>This script simply gathers together the required inputs before executing\nDeepVariant within the docker container, it can be run simply with:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">./run_deepvariant.sh \\\n    -b medaka_variant/round_0_hap_mixed_phased.bam \\\n    -v medaka_variant/round_1.vcf \\\n    -r GCA_000001405.15_GRCh38_no_alt_analysis_set.fasta \\\n    -o deep_variant -t 64 -q</code></pre></div>\n<p>The final variant calls will be present at <code class=\"language-text\">deepvariant/deepvariant.vcf.gz</code>.\nThe <code class=\"language-text\">-q</code> option here runs a “high quality” version of the DeepVariant\ncalculation; this version incurs a runtime cost of aaround a factor of\nfour and gives marginable improvement in results.</p>\n<h3>Evaluation</h3>\n<p>The veracity of the variant calling performed above can be obtained by\ncomparing the results to the <a href=\"https://www.nist.gov/programs-projects/genome-bottle\">Genome In A\nBottle</a> truth sets for\nthe GM24385 sample. The truth sets can be downloaded from the\n<a href=\"https://www.ncbi.nlm.nih.gov/\">NCBI</a> repository:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">for ext in .bed .bed.gz .bed.gz.tbi .vcf.gz .vcf.gz.tbi; do\n    wget https://ftp-trace.ncbi.nlm.nih.gov/ReferenceSamples/giab/release/AshkenazimTrio/HG002_NA24385_son/NISTv4.1/GRCh38/HG002_GRCh38_1_22_v4.1_draft_benchmark${ext}\ndone</code></pre></div>\n<p>With these reference data we will use\n<a href=\"https://github.com/Illumina/hap.py\">hap.py</a> to assess the recall and precision\nof the variant calls made by DeepVariant. Hap.py is most easily run using the\ndocker container provided by it’s authors:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">docker run -it -v ${PWD}:${PWD} pkrusche/hap.py /opt/hap.py/bin/hap.py \\\n    ${PWD}/HG002_GRCh38_1_22_v4.1_draft_benchmark.vcf.gz ${PWD}/deepvariant/deepvariant.vcf.gz \\\n    -f ${PWD}/HG002_GRCh38_1_22_v4.1_draft_benchmark.bed \\\n    -r ${PWD}/GCA_000001405.15_GRCh38_no_alt_analysis_set.fasta \\\n    -o happy_out --pass-only -l chr20 --engine=vcfeval --threads=20</code></pre></div>\n<p>The output of the above will be a table summarising the results of the\ncomparison. An abbreviated form is given below:</p>\n<table>\n<thead>\n<tr>\n<th>Type</th>\n<th>INDEL</th>\n<th>SNP</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>TRUTH.TOTAL</td>\n<td>11271</td>\n<td>71334</td>\n</tr>\n<tr>\n<td>METRIC.Recall</td>\n<td>0.5927</td>\n<td>0.9972</td>\n</tr>\n<tr>\n<td>METRIC.Precision</td>\n<td>0.8384</td>\n<td>0.9973</td>\n</tr>\n<tr>\n<td>METRIC.F1_Score</td>\n<td>0.6944</td>\n<td>0.9973</td>\n</tr>\n</tbody>\n</table>\n<p>An active area of research is the calling of variants in low complexity regions.\nThe NCBI reference data includes an index of such regions, we can mask these\nregions from the comparison:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">wget https://ftp-trace.ncbi.nlm.nih.gov/ReferenceSamples/giab/release/genome-stratifications/v2.0/GRCh38/LowComplexity/GRCh38_notinAllTandemRepeatsandHomopolymers_slop5.bed.gz\nbedtools intersect \\\n    -a HG002_GRCh38_1_22_v4.1_draft_benchmark.bed \\\n    -b GRCh38_notinAllTandemRepeatsandHomopolymers_slop5.bed.gz \n    &gt; HG002_GRCh38_1_22_v4.1_draft_benchmark.norepeat.bed\n\ndocker run -it -v ${PWD}:${PWD} pkrusche/hap.py /opt/hap.py/bin/hap.py \\\n    ${PWD}/HG002_GRCh38_GIABv4.1.vcf.gz ${PWD}/deepvariant/deepvariant.vcf.gz \\\n    -f ${PWD}/ HG002_GRCh38_1_22_v4.1_draft_benchmark.norepeat.bed \\\n    -r ${PWD}/truths/GRCh38_no_alt_chr20.fa \\\n    -o happy_out --pass-only -l chr20 --engine=vcfeval --threads=20</code></pre></div>\n<p>With these regions masked we now obtain:</p>\n<table>\n<thead>\n<tr>\n<th>Type</th>\n<th>INDEL</th>\n<th>SNP</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>METRIC.Recall</td>\n<td>0.9458</td>\n<td>0.9992</td>\n</tr>\n<tr>\n<td>METRIC.Precision</td>\n<td>0.9827</td>\n<td>0.9992</td>\n</tr>\n<tr>\n<td>METRIC.F1_Score</td>\n<td>0.9639</td>\n<td>0.9992</td>\n</tr>\n</tbody>\n</table>\n<p>The latest research basecallers are better able to provide accurate calls\nthrough low complexity regions. The example below compares basecalls produced\nwith Guppy 4.0.11 and the soon to be release Bonito version 0.3.0 basecaller.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/ont-open-datasets/static/8664b21a426197e8eec64f62a26df624/46e51/bonito_igv.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 36.486486486486484%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsSAAALEgHS3X78AAABiklEQVQozz2R/W+aUBiF+f//G7O2fNmudUptARVwW2YAFUFcmkxFvmyXPHuhyX54cs6597w3ufcqbdtyvV4py4rDIadpSo7HP+R5RlUVwqXXui4pzkdZT6Vb9Gtvbweq+kJRnPr+5XJCyfOc/T4ny1KCIMIPMnw/xJ3F4lMhwfN2eH7C3NvgunHvfaHX4HPPna1FdyhVVdE2Le37la0dEA+e2GgTNuqYcPDIr5spkTZl9vCN7/cTIvOZULNYGRNi1RImrEXXMhOJV47HI01d08iBibMguRuRmBaJPmarjtjqFhvJ8Veb+NElkYMSXTqGxbbrSd52SD82RyhN01BXNaW81Q97haMGzMwlMyNgri1EPVzDZzqcYz0EuNoc1/RwjEXf6XCNJa7ezSxRzuczl+LC+98P1vZPwtsXIsMh1F/Fj+W6jmB/ZtGV+kykv8iV5Sl0h1gIVee/V06nk/zemaIsSe1X9uoNvw2VvXbL/m7AztBITck9d6T3GpunIZnkTHJHKnR7yfAL/wA/buqVykjzHwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"bonito_low_complexity_calls\"\n        title=\"Bonito Low Complexity Basecalls\"\n        src=\"/ont-open-datasets/static/8664b21a426197e8eec64f62a26df624/fcda8/bonito_igv.png\"\n        srcset=\"/ont-open-datasets/static/8664b21a426197e8eec64f62a26df624/12f09/bonito_igv.png 148w,\n/ont-open-datasets/static/8664b21a426197e8eec64f62a26df624/e4a3f/bonito_igv.png 295w,\n/ont-open-datasets/static/8664b21a426197e8eec64f62a26df624/fcda8/bonito_igv.png 590w,\n/ont-open-datasets/static/8664b21a426197e8eec64f62a26df624/efc66/bonito_igv.png 885w,\n/ont-open-datasets/static/8664b21a426197e8eec64f62a26df624/46e51/bonito_igv.png 1003w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>The <a href=\"http://software.broadinstitute.org/software/igv/\">IGV</a> screenshot shows\nhow the Bonito basecaller is less prone to long deletion tracks in the low\ncomplexity region. With improvements to basecalling we therefore anticipate\nbeing able to produce highly accurate INDEL calls in these regions in the near\nfuture.</p>\n<h3>Acknowledgements</h3>\n<p>We kindly acknowledge Andrew Carroll of Google Health and Benedict Paten’s\ngroup at the Computational Genomics Lab, UC Santa Cruz Genomics Institute for\nreleasing the DeepVariant inference models for nanopore data and discussions\nconcerning how to present variant candidates to DeepVariant.</p>","frontmatter":{"title":"Small variant calling with GM24385","date":"October 15, 2020","description":"Small variant calling with GM24385 (GIAB HG002)"}}},"pageContext":{"slug":"/gm24385_snp/","previous":{"fields":{"slug":"/katuali_human_pipeline/"},"frontmatter":{"title":"Katuali analysis pipeline for preparing human datasets"}},"next":{"fields":{"slug":"/bonito/"},"frontmatter":{"title":"Bonito basecalling with R9.4.1"}}}},"staticQueryHashes":["1246554614","1462070832","2841359383"]}